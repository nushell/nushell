<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

  <?define ProductName = "Nushell" ?>
  <?define ApplicationFolderName = "nu" ?>
  <?define ProductVersion = "$(env.NU_RELEASE_VERSION)" ?>
  <?define Manufacturer = "The Nushell Project Developers" ?>
  <?define UpgradeCode = "82D756D2-19FA-4F09-B10F-64942E89F364" ?>

  <!-- https://docs.firegiant.com/wix/schema/wxs/package/ -->
  <Package
    Compressed="yes"
    Id="Nushell.Nushell"
    InstallerVersion="500"
    Scope="perUserOrMachine"
    Name="$(var.ProductName)"
    Version="$(var.ProductVersion)"
    UpgradeCode="$(var.UpgradeCode)"
    Manufacturer="$(var.Manufacturer)" >

    <MajorUpgrade
      MigrateFeatures="yes"
      Schedule="afterInstallInitialize"
      DowngradeErrorMessage="A newer version of [ProductName] is already installed. Setup will now exit." />

    <!-- Embed cab media to MSI file -->
    <Media Id="1" Cabinet="cab1.cab" EmbedCab="yes" />

    <!-- Allow install for Current User Or Machine -->
    <Property Id="WixUISupportPerUser" Value="1" />
    <Property Id="WixUISupportPerMachine" Value="1" />
    <!-- Install for PerUser by default -->
    <!-- If set to WixPerMachineFolder will install for PerMachine by default -->
    <Property Id="WixAppFolder" Value="WixPerUserFolder" />

    <!-- Enable UAC prompt when installing for all users -->
    <!-- <Property Id="MSIUSEREALADMINDETECTION" Value="1" /> -->

    <Property Id="ApplicationFolderName" Value="$(var.ApplicationFolderName)" />

    <!-- Per Machine Install -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLDIR" Name="$(var.ApplicationFolderName)">
        <Directory Id="BINDIR" Name="bin" />
      </Directory>
    </StandardDirectory>

    <!-- Install for Current User -->
    <StandardDirectory Id="LocalAppDataFolder">
      <Directory Id="LocalAppProgramsFolder" Name="Programs">
        <Directory Id="INSTALLDIR_USER" Name="$(var.ApplicationFolderName)">
          <Directory Id="BINDIR_USER" Name="bin" />
        </Directory>
      </Directory>

      <!-- Windows Terminal Profile Directories -->
      <Directory Id="AppDataMicrosoftFolder" Name="Microsoft">
        <Directory Id="AppDataWindowsTerminalFolder" Name="Windows Terminal">
          <Directory Id="WindowsTerminalProfileFolder" Name="Fragments">
            <Directory Id="WindowsTerminalProfileAppFolder" Name="nu">
              <Component Id="WindowsTerminalProfile" Guid="957239F4-7B87-4399-9F91-7DF2ABE5ED8B">
                <File Id="WindowsTerminalProfileFile"
                      Name="nu.json"
                      Source="$(var.ProjectDir)\windows-terminal-profile.json" />
                <RegistryValue Root="HKCU"
                               Key="Software\nu"
                               Name="WindowsTerminalProfile"
                               Value="1"
                               Type="integer"
                               KeyPath="yes" />
                <RemoveFolder Id="RemoveWindowsTerminalProfileFolderA" Directory="WindowsTerminalProfileAppFolder" On="uninstall" />
                <RemoveFolder Id="RemoveWindowsTerminalProfileFolderB" Directory="WindowsTerminalProfileFolder" On="uninstall" />
                <RemoveFolder Id="RemoveWindowsTerminalProfileFolderC" Directory="AppDataWindowsTerminalFolder" On="uninstall" />
                <RemoveFolder Id="RemoveWindowsTerminalProfileFolderD" Directory="AppDataMicrosoftFolder" On="uninstall" />
              </Component>
            </Directory>
          </Directory>
        </Directory>
      </Directory>
    </StandardDirectory>

    <ComponentGroup Id="NushellBinaries" Directory="BINDIR">
      <Component Id="Nu_Main" Guid="*">
        <File Id="nu.exe" Source="$(var.SourceDir)\nu.exe" KeyPath="yes" />
      </Component>
      <Component Id="Nu_Plugin_Inc" Guid="*">
        <File Id="nu_plugin_inc.exe" Source="$(var.SourceDir)\nu_plugin_inc.exe" KeyPath="yes" />
      </Component>
      <Component Id="Nu_Plugin_Gstat" Guid="*">
        <File Id="nu_plugin_gstat.exe" Source="$(var.SourceDir)\nu_plugin_gstat.exe" KeyPath="yes" />
      </Component>
      <Component Id="Nu_Plugin_Query" Guid="*">
        <File Id="nu_plugin_query.exe" Source="$(var.SourceDir)\nu_plugin_query.exe" KeyPath="yes" />
      </Component>
      <Component Id="Nu_Plugin_Polars" Guid="*">
        <File Id="nu_plugin_polars.exe" Source="$(var.SourceDir)\nu_plugin_polars.exe" KeyPath="yes" />
      </Component>
      <Component Id="Nu_Plugin_Formats" Guid="*">
        <File Id="nu_plugin_formats.exe" Source="$(var.SourceDir)\nu_plugin_formats.exe" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- License and Icon in main directory -->
    <ComponentGroup Id="NushellResources" Directory="INSTALLDIR">
      <Component Id="Nu_Icon" Guid="*">
        <File Id="nu.ico" Source="$(var.ProjectDir)\nu.ico" KeyPath="yes" />
      </Component>
      <Component Id="Nu_Readme" Guid="*">
        <File Id="README.txt" Source="$(var.ProjectDir)\README.txt" KeyPath="yes" />
      </Component>
      <Component Id="Nu_License" Guid="*">
        <File Id="License.rtf" Source="$(var.ProjectDir)\License.rtf" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Environment PATH variable components - separated for per-user and per-machine -->
    <DirectoryRef Id="BINDIR">
      <!-- Per-user PATH component -->
      <Component Id="EnvironmentPathUser" Guid="{D6A3A7B2-1F3A-4B6A-8A3B-3A7B2D6A3A7B}" Condition="MSIINSTALLPERUSER=1">
        <Environment Id="PATHUser"
                     Name="PATH"
                     Value="[BINDIR]"
                     Permanent="no"
                     Part="last"
                     Action="set"
                     System="no" />
        <RegistryValue Root="HKCU"
                       Key="Software\nu"
                       Name="installed"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>

      <!-- Per-machine PATH component -->
      <Component Id="EnvironmentPathMachine" Guid="{47781325-8A2B-4F8D-A058-9A2C4136E25F}" Condition="ALLUSERS=1">
        <Environment Id="PATHMachine"
                     Name="PATH"
                     Value="[BINDIR]"
                     Permanent="no"
                     Part="last"
                     Action="set"
                     System="yes" />
        <RegistryValue Root="HKLM"
                       Key="Software\nu"
                       Name="installed"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- Main feature set -->
    <Feature Id="ProductFeature" Title="Nushell" Level="1">
      <ComponentGroupRef Id="NushellBinaries" />
      <ComponentGroupRef Id="NushellResources" />
      <ComponentRef Id="EnvironmentPathUser" />
      <ComponentRef Id="EnvironmentPathMachine" />
    </Feature>

    <!-- Windows Terminal Profile Feature -->
    <Feature Id="WindowsTerminalProfile"
             Title="Windows Terminal Profile"
             Description="Add $(var.ProductName) profile to Windows Terminal."
             Level="1">
      <ComponentRef Id="WindowsTerminalProfile" />
    </Feature>

    <!-- Load Advanced UI -->
    <WixVariable Id="WixUILicenseRtf" Value="$(var.ProjectDir)\License.rtf" />
    <ui:WixUI Id="WixUI_Advanced" />

    <!-- Windows Version Check -->
    <Launch Condition="VersionNT >= 601" Message="This application requires Windows 7 or later." />

    <!-- Arch checking -->
    <?if $(sys.BUILDARCH) = x64 ?>
      <Launch Condition="VersionNT64" Message="This installation package is only supported on 64-bit Windows." />
    <?endif?>

    <?if $(sys.BUILDARCH) = arm64 ?>
      <Launch Condition="ProcessorArchitecture = 'ARM64'" Message="This installation package is only supported on ARM64 Windows." />
    <?endif?>

    <SetProperty Id="INSTALLDIR"
                 Action="SetINSTALLDIR_User"
                 Value="[INSTALLDIR_USER]"
                 After="AppSearch"
                 Condition="MSIINSTALLPERUSER=1"
                 Sequence="both" />
    <SetProperty Id="BINDIR"
                 Action="SetBINDIR_User"
                 Value="[BINDIR_USER]"
                 After="AppSearch"
                 Condition="MSIINSTALLPERUSER=1"
                 Sequence="both" />

    <!-- If Installed with ALLUSERS=1 set the default Install dir to ProgramFiles64Folder -->
    <SetProperty Id="INSTALLDIR"
                 Action="SetINSTALLDIR_Machine"
                 Value="[ProgramFiles64Folder][ApplicationFolderName]"
                 After="AppSearch"
                 Condition="ALLUSERS=1"
                 Sequence="both" />
    <SetProperty Id="BINDIR"
                 Action="SetBINDIR_Machine"
                 Value="[ProgramFiles64Folder][ApplicationFolderName]\bin"
                 After="AppSearch"
                 Condition="ALLUSERS=1"
                 Sequence="both" />

    <!-- Custom Action for Windows Terminal Profile -->
    <SetProperty Id="ReplacePathsInWindowsTerminalProfile"
                 Sequence="execute"
                 Value="&quot;[#nu.exe]&quot; -c &quot;let doc = (open `[#WindowsTerminalProfileFile]` | update profiles.commandline `[#nu.exe]` | update profiles.icon `[#nu.ico]`); $doc | save -f `[#WindowsTerminalProfileFile]`&quot;"
                 After="CostFinalize" />

    <CustomAction Id="ReplacePathsInWindowsTerminalProfile"
                  Return="check"
                  Impersonate="yes"
                  Execute="deferred"
                  DllEntry="WixQuietExec"
                  BinaryRef="Wix4UtilCA_X64" />

    <InstallExecuteSequence>
      <Custom Action="ReplacePathsInWindowsTerminalProfile" Before="InstallFinalize"
              Condition="(&amp;WindowsTerminalProfile=3) OR ((!WindowsTerminalProfile=3) AND (REINSTALL&lt;&gt;&quot;&quot;))"/>
    </InstallExecuteSequence>
  </Package>
</Wix>
